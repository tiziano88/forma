#!/usr/bin/env node

/**
 * Generates TypeScript file with embedded config schema
 * This runs at build time to ensure the schema stays in sync with forma.proto
 */

import { execSync } from 'child_process';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Ensure output directory exists
const outputDir = path.join(__dirname, '../src/generated');
if (!fs.existsSync(outputDir)) {
  fs.mkdirSync(outputDir, { recursive: true });
}

const descPath = path.join(outputDir, 'config.desc');
const tsPath = path.join(outputDir, 'config-schema.ts');

console.log('[Forma] Generating config schema descriptor...');

// Run protoc to generate descriptor
// We need to cd to the repo root to properly resolve the proto path
try {
  execSync(
    `cd .. && protoc --descriptor_set_out=chrome-extension/src/generated/config.desc --include_imports --include_source_info config/forma.proto`,
    { stdio: 'inherit' }
  );
} catch (error) {
  console.error('[Forma] Failed to generate descriptor');
  process.exit(1);
}

// Read the binary descriptor
const descriptorBytes = fs.readFileSync(descPath);

// Convert to base64
const base64 = descriptorBytes.toString('base64');

// Generate TypeScript file
const tsContent = `// Auto-generated by scripts/generate-config-schema.js - DO NOT EDIT MANUALLY
// This file is generated at build time from config/forma.proto

/**
 * Base64-encoded protobuf descriptor for forma.config.Config
 * Used to parse config.forma.binpb files
 */
export const CONFIG_SCHEMA_BASE64 = '${base64}';

/**
 * Decode the schema to Uint8Array for use with protobuf parser
 */
export function getConfigSchemaBytes(): Uint8Array {
  const binaryString = atob(CONFIG_SCHEMA_BASE64);
  const bytes = new Uint8Array(binaryString.length);
  for (let i = 0; i < binaryString.length; i++) {
    bytes[i] = binaryString.charCodeAt(i);
  }
  return bytes;
}
`;

fs.writeFileSync(tsPath, tsContent);

console.log(`[Forma] Generated ${tsPath} (${base64.length} chars base64, ${descriptorBytes.length} bytes binary)`);

// Clean up the .desc file since we've embedded it in TypeScript
fs.unlinkSync(descPath);
console.log('[Forma] Cleaned up temporary descriptor file');
